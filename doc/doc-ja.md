
# はじめに

XMLファイルをSATySFiのsatyファイルに変換するソフトウェアを作成しました。

名前はやや安直で、"xml2saty"です。リポジトリは[ここ](https://github.com/puripuri2100/xml2saty)にあります。

# インストール

- OPAMをインストールします
```
sh <(curl -sL https://raw.githubusercontent.com/ocaml/opam/master/shell/install.sh)
```
で入ります。
- OCamlをインストールします
```
opam init --comp 4.07.0

eval $(opam env)
```
などとすると良いでしょう（Ubuntu on WSLえを使っている人は`opam init`の際に`--disable-sandboxing`というオプションをつけてください）。
バージョンは古すぎなければ大体のもので動くと思われます。
- 依存ライブラリをインストールする
```
opam install xml-light
opam install menhir
```
でインストールできます。既に入っている場合はしなくて大丈夫です。
- リポジトリをクローンしてビルドする
```
git clone https://github.com/puripuri2100/xml2saty.git
cd xml2saty
make build
```
でビルドができ、フォルダに`xml2saty`という名前の実行ファイルができます。

後は適当にフォルダに移動させるなりしてパスを適切に設定してください。

# 使い方

`-f`もしくは`--file`オプションでXMLファイルを渡すことができます。このオプションは省略することができます。

`-o`または`--output`オプションで出力ファイル名を指定できます。無い場合は入力のファイル名を流用します。オプションそのものを省略するとXMLファイルの名前から自動的にファイルが作成されます。

`-c`または`--config`で設定ファイルを渡すことができます。オプションそのものを省略するとXMLファイルの名前から自動的に設定ファイルが探されます。

`-p`または`--package`でSATySFiのパッケージファイルとして出力することができます。

`-t`または`--text`で直接XML文字列を渡すことができます。このとき、`-o`・`--output`・`-c`・`--config`オプションは省略できません。

起動は

```
xml2saty -f 〈XMLファイル〉 -o 〈satyファイル〉 -c 〈設定ファイル〉
```

または

```
xml2saty -f 〈XMLファイル〉 -o 〈satyファイル〉 -c 〈設定ファイル〉 -p
```

です。

## 入力するXMLファイルについて

xml-lightパッケージが処理できる正しいXMLファイルである必要があります。

また、要素の名前などについてはASCII文字以外である場合の動作については保証できません。

また、ファイル名を渡すときに拡張子は省略できません。

## 出力ファイルについて

`-o`や`--output`オプションに渡すファイル名では拡張子を省略できません。

## パッケージとして出力する際について

`-p`や`--package`オプションを使う時は設定ファイルの`module`の項を必ず書くようにしてください。

## 設定ファイルについて

設定ファイルの拡張子は`.x2s-config`で、文法はオリジナルのものです。

```
require [stdja; list]
```

のように

```
〈設定タグ〉 [〈リスト〉]
```

のように記述します。リストの区切りはセミコロンです。また、リスト内で使える文字列は以下の文字列を含まないものです。
- 設定タグで使われている単語3つ
- SATySFiの型名
- 括弧
- セミコロン
- コンマ
- アスタリスク
- ダブルクオーテーション

設定タグは

- `require`：`@require:`の後に記述されるパッケージ名（パス）をリストの形で書きます。
- `import`：`@import:`の後に記述されるパッケージの相対パスをリストの形で書きます。
- `module`：出力するパッケージファイルのモジュール名と、文書全体の関数名をタプルで指定します。そのため、
```
module (ModuleName, document)
```
のように記述することになります。
- `attrib`：要素の属性の変換方法ついて指定をします。例えば
```
attrib
  [
    Paragraph (block-text)(2)[
      (Hide, bool, 2);
      (Num, int, 1)
    ];
    ParagraphNum(inline-text)[];
    ParagraphCaption(inline-text)[];
    ParagraphSentence -> PS (inline-text)[];
    Sentence (inline-text)(1)[
      (WritingMode, string, 1);
    ];
  ]
```
みたいな感じです。
詳しく書くと、

`〈要素名についての指定〉 〈型について指定〉 〈属性の数についての指定〉 〈属性についてのリスト〉`

のリストになります。
〈要素名についての指定〉では、単純に文字列を書くだけですが、もしコマンド等にするときに属性の名前を変えたいと思ったら`〈旧名前〉 -> 〈新名前〉`のように、矢印を使って新しい名前を指定します。矢印の前後には半角空白が必要です。
〈型について指定〉と〈属性の数についての指定〉を書く際には丸括弧が必須です。
また、どちらも省略が可能です。省略するとそれぞれ「`unit`型」と「属性についてのリストの長さ」になります。
また、〈属性の数〉で0より小さな数を指定していた場合は自動的に「属性についてのリストの長さ」になります。

〈属性についてのリスト〉では〈属性名〉・〈型〉・〈コマンドにしたときに何番目の引数か〉の3つの要素のタプルです。
このリストに含まれなかった属性の場合や、〈何番目か〉のところで〈属性の数〉で指定した数より大きい数か0以下の数字を渡していた場合は、その属性は無視されて`None`が返されます。
また、属性は「その属性が無かったら`None`を、あったら`Some(var)`を返す」という挙動をするようにしているため、全て`'a option`型になります。

これらを与えることで出力されるファイルの中身を制御できるようになります。


使える型名は現在のところ

- `string`
- `int`
- `bool`
- `float`
- `length`
- `inline-text`
- `block-text`
- `funciton`
- `<type> list`

です。`function`を選択すると、要素の中にある子要素が全て関数扱いになり、先頭が小文字になります。
`inline-text`は先頭に`\`が付き、`block-text`は`+`が付きます。
`inline-text list`のように`<type> list`のように書くことでリストの形でも出力できます。




# 使用例

リポジトリにexampleフォルダの中にe-Gov法令検索からダウンロードできる元号法と刑法のXMLファイルが置いてあります。

```
make example
```

でsatyファイルを作成することができます。

付属の`local.satyh`にコマンドの定義が書いてあるのでそれを使って
```
satysfi example/keihou.saty -o example/keihou.pdf
```
のようにしてコンパイルすることができます。

また、これを応用することによりHTMLファイルをsatyファイルに変換することも可能なはずです。